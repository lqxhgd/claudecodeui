name: Release

on:
  push:
    tags: ['v*']

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - run: npm ci
      - run: npm run build

      - name: Docker Build & Push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:latest
            ghcr.io/${{ github.repository }}:${{ github.ref_name }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true

      - name: Notify WeChat Work
        if: always()
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            EVENT="deploy_success"
            MSG="## ✅ 部署成功\n> **项目**: ${{ github.repository }}\n> **版本**: ${{ github.ref_name }}\n> **时间**: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          else
            EVENT="deploy_failure"
            MSG="## ❌ 部署失败\n> **项目**: ${{ github.repository }}\n> **版本**: ${{ github.ref_name }}\n> **时间**: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          fi
          if [ -n "${{ secrets.WECHAT_WORK_WEBHOOK_URL }}" ]; then
            curl -s -X POST "${{ secrets.WECHAT_WORK_WEBHOOK_URL }}" \
              -H 'Content-Type: application/json' \
              -d "{\"msgtype\":\"markdown\",\"markdown\":{\"content\":\"$MSG\"}}"
          fi
